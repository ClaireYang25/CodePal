# ğŸ”§ Gmail OTP AutoFill - å¼€å‘é—®é¢˜æ—¥å¿—

æœ¬æ–‡æ¡£æŒ‰æ—¶é—´é¡ºåºè®°å½•äº†å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸»è¦é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆã€‚

---

### é—®é¢˜ 1: [æ—©æœŸæ¶æ„] ä½¿ç”¨ Gmail API å¯¼è‡´è®¤è¯æµç¨‹å¤æ‚
- **èƒŒæ™¯**: é¡¹ç›®æœ€æ—©æœŸçš„åŸå‹å°è¯•ä½¿ç”¨ Gmail API æ¥è¯»å–é‚®ä»¶ã€‚
- **ç°è±¡**: æ¯æ¬¡ä½¿ç”¨éƒ½éœ€è¦ç”¨æˆ·è¿›è¡Œå¤æ‚çš„ Google è´¦å·æˆæƒï¼ˆOAuth 2.0ï¼‰ï¼Œå¢åŠ äº†ç”¨æˆ·çš„æ“ä½œæ­¥éª¤å’Œå­¦ä¹ æˆæœ¬ï¼Œä¹Ÿå¼•å‘äº†å…³äºæ•°æ®æƒé™çš„å®‰å…¨ç–‘è™‘ã€‚
- **è§£å†³æ–¹æ¡ˆ**: æˆ‘ä»¬æœæ–­æ”¾å¼ƒäº† Gmail APIï¼Œè½¬å‘ä½¿ç”¨ **Content Script**ã€‚é€šè¿‡ç›´æ¥åœ¨ Gmail é¡µé¢å†…æ³¨å…¥è„šæœ¬æ¥ç›‘å¬å’Œè¯»å–æ–°é‚®ä»¶çš„ DOMï¼Œæ¶æ„å˜å¾—æ›´ç®€å•ã€æ›´å®‰å…¨ï¼Œå¹¶ä¸”å®Œå…¨æ— éœ€ç”¨æˆ·è¿›è¡Œä»»ä½•é¢å¤–çš„æˆæƒæ“ä½œï¼Œå®ç°äº†â€œå³è£…å³ç”¨â€çš„ä½“éªŒã€‚

### é—®é¢˜ 2: [Manifest] å‡ºç° `Unrecognized manifest key 'offscreen'` è­¦å‘Š
- **èƒŒæ™¯**: åœ¨ `manifest.json` ä¸­æ·»åŠ  `offscreen` æƒé™åã€‚
- **ç°è±¡**: åŠ è½½æ‰©å±•æ—¶ï¼Œ`chrome://extensions` é¡µé¢å‡ºç°æ­¤è­¦å‘Šã€‚
- **åŸå› **: ä½¿ç”¨çš„ Chrome æµè§ˆå™¨ç‰ˆæœ¬ä½äº 116ï¼Œè¯¥ç‰ˆæœ¬å°šä¸æ”¯æŒ `manifest.json` ä¸­çš„ `offscreen` å­—æ®µã€‚
- **è§£å†³æ–¹æ¡ˆ**: ä¸ºäº†å‘å‰å…¼å®¹ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­åŠ å…¥äº†åŠ¨æ€æ£€æŸ¥ `if (chrome.offscreen)`ï¼Œåªæœ‰åœ¨ API å­˜åœ¨æ—¶æ‰è°ƒç”¨å®ƒï¼Œä»è€Œå®ç°ä¼˜é›…é™çº§ã€‚å¯¹äºä½ç‰ˆæœ¬æµè§ˆå™¨ï¼ŒNano åŠŸèƒ½å°†ä¸å¯ç”¨ï¼Œä½†æ‰©å±•çš„å…¶ä½™éƒ¨åˆ†ä¸å—å½±å“ã€‚

### é—®é¢˜ 3: [Manifest] å‡ºç° `Permission 'modelAccess' is unknown'` è­¦å‘Š
- **èƒŒæ™¯**: `manifest.json` é…ç½®é˜¶æ®µã€‚
- **ç°è±¡**: åŠ è½½æ‰©å±•æ—¶å‡ºç°å…³äº `modelAccess` æƒé™çš„è­¦å‘Šã€‚
- **åŸå› **: `modelAccess` æ˜¯ä¸€ä¸ªå®éªŒæ€§çš„ã€ä¸”åœ¨æŸäº› Chrome ç‰ˆæœ¬ä¸­å·²è¢«å¼ƒç”¨çš„æƒé™ã€‚å®ƒå¯¹äºæˆ‘ä»¬ä½¿ç”¨çš„ Prompt API å¹¶éå¿…éœ€ã€‚
- **è§£å†³æ–¹æ¡ˆ**: ä» `manifest.json` çš„ `permissions` æ•°ç»„ä¸­å½»åº•ç§»é™¤è¯¥æƒé™å£°æ˜ã€‚

### é—®é¢˜ 4: [Nano é›†æˆ] æµ‹è¯•å¤±è´¥ - `Offscreen API not available`
- **èƒŒæ™¯**: é¦–æ¬¡å°è¯•åœ¨ Service Worker ä¸­ç›´æ¥è°ƒç”¨ Gemini Nano APIã€‚
- **ç°è±¡**: æµ‹è¯• Nano åŠŸèƒ½æ—¶æ€»æ˜¯å¤±è´¥ï¼Œå¹¶æç¤º Offscreen API ä¸å¯ç”¨ã€‚
- **åŸå› **: Service Worker æ˜¯ä¸€ä¸ªæ²¡æœ‰ `window` å’Œ DOM API çš„æ‰§è¡Œç¯å¢ƒï¼Œè€Œ Gemini Nanoï¼ˆPrompt APIï¼‰**å¿…é¡»**åœ¨æ‹¥æœ‰ `window` å¯¹è±¡çš„ç¯å¢ƒä¸­è¿è¡Œã€‚
- **è§£å†³æ–¹æ¡ˆ**: æ˜ç¡®äº†å¿…é¡»ä½¿ç”¨ Offscreen Documentã€‚æˆ‘ä»¬å°†å…¶è®¾è®¡ä¸º Service Worker è°ƒç”¨ Gemini Nano çš„å”¯ä¸€æ¡¥æ¢ï¼šService Worker å°†ä»»åŠ¡é€šè¿‡æ¶ˆæ¯ä¼ é€’ç»™ Offscreen Documentï¼Œåè€…åœ¨å…·å¤‡ `window` çš„ç¯å¢ƒä¸­æ‰§è¡Œ Nano APIï¼Œç„¶åå°†ç»“æœè¿”å›ã€‚è¿™å½»åº•è§£å†³äº† Service Worker çš„ç¯å¢ƒé™åˆ¶é—®é¢˜ã€‚

### é—®é¢˜ 5: [Nano API] è°ƒç”¨è­¦å‘Š - `No output language was specified...`
- **èƒŒæ™¯**: åœ¨ Offscreen Document ä¸­é¦–æ¬¡æˆåŠŸè°ƒç”¨ `LanguageModel.create()`ã€‚
- **ç°è±¡**: åœ¨ Offscreen æ§åˆ¶å°ä¸­å‡ºç°è­¦å‘Šï¼Œæç¤ºæ²¡æœ‰ä¸º LanguageModel API è¯·æ±‚æŒ‡å®šè¾“å‡ºè¯­è¨€ã€‚
- **åŸå› **: Nano API å¼ºåˆ¶è¦æ±‚æ˜ç¡®æŒ‡å®šè¾“å…¥å’Œè¾“å‡ºè¯­è¨€ï¼Œä»¥ä¿è¯å®‰å…¨æ€§å’Œè¾“å‡ºè´¨é‡ã€‚
- **è§£å†³æ–¹æ¡ˆ**: åœ¨ `LanguageModel.create()` å’Œ `LanguageModel.availability()` çš„è°ƒç”¨ä¸­ï¼Œéƒ½æ˜ç¡®æä¾›äº† `expectedInputs` å’Œ `expectedOutputs` å‚æ•°ï¼Œä¾‹å¦‚ï¼š`expectedOutputs: [{ type: 'text', languages: ['en'] }]`ã€‚

### é—®é¢˜ 6: [Nano API] è°ƒç”¨é”™è¯¯ - `Failed to read the 'type' property...`
- **èƒŒæ™¯**: åœ¨è§£å†³ä¸Šä¸€ä¸ªè¯­è¨€è­¦å‘Šé—®é¢˜æ—¶ã€‚
- **ç°è±¡**: è°ƒç”¨ Nano API æ—¶æŠ›å‡º `TypeError`ï¼ŒæŒ‡ç¤º `expectedOutputs` æ ¼å¼é”™è¯¯ã€‚
- **åŸå› **: `expectedOutputs` çš„è¯­æ³•ç»“æ„ä¸æ­£ç¡®ï¼Œæœ€åˆå¯èƒ½å†™æˆäº† `language: 'en'` è€Œä¸æ˜¯æ ‡å‡†è¦æ±‚çš„ `languages: ['en']`ã€‚
- **è§£å†³æ–¹æ¡ˆ**: ä¿®æ­£ä¸º API æ–‡æ¡£è¦æ±‚çš„æ ‡å‡†æ•°ç»„å¯¹è±¡æ ¼å¼ï¼š`expectedOutputs: [{ type: 'text', languages: ['en'] }]`ã€‚

### é—®é¢˜ 7: [æ¶ˆæ¯è·¯ç”±] æµ‹è¯•æ—¶å‡ºç° `Unknown action` é”™è¯¯
- **èƒŒæ™¯**: åœ¨ Popupã€Service Worker å’Œ Offscreen ä¸‰è€…ä¹‹é—´è”è°ƒæ—¶ã€‚
- **ç°è±¡**: ä» popup ç‚¹å‡»â€œæµ‹è¯•Nanoâ€æŒ‰é’®åï¼ŒService Worker æ§åˆ¶å°æŠ¥é”™ `Unknown action`ã€‚
- **åŸå› **: æ¶ˆæ¯è·¯ç”±å†²çªã€‚å‘å¾€ Offscreen Document ç”¨äºæµ‹è¯•è¿æ¥çš„æ¶ˆæ¯ï¼Œè¢« Service Worker é”™è¯¯åœ°æ‹¦æˆªå¹¶å¤„ç†äº†ï¼Œä½† Service Worker çš„æ¶ˆæ¯å¤„ç†å™¨ä¸­å¹¶æ²¡æœ‰å®šä¹‰ç›¸åº”çš„ actionã€‚
- **è§£å†³æ–¹æ¡ˆ**: å®æ–½äº†**æ¶ˆæ¯ç›®æ ‡ç³»ç»Ÿ**ã€‚åœ¨ä» Service Worker å‘å¾€ Offscreen Document æ—¶ï¼Œä¸ºæ¶ˆæ¯å¢åŠ  `target: 'offscreen'` å±æ€§ã€‚åŒæ—¶ï¼Œåœ¨ Offscreen å’Œ Service Worker çš„æ¶ˆæ¯ç›‘å¬å™¨ä¸­éƒ½åŠ å…¥äº†å¯¹ `target` å±æ€§çš„æ£€æŸ¥ï¼Œä»è€Œç¡®ä¿æ¯ä¸ªç»„ä»¶åªå¤„ç†å‘ç»™è‡ªå·±çš„æ¶ˆæ¯ã€‚

### é—®é¢˜ 8: [æ ¸å¿ƒé€»è¾‘] é‚®ä»¶å¤„ç†å¤±è´¥ - `All OTP extraction methods failed`
- **èƒŒæ™¯**: è”è°ƒ Content Script å’Œ Service Worker æ—¶ã€‚
- **ç°è±¡**: æ–°é‚®ä»¶åˆ°è¾¾åï¼ŒService Worker æŠ¥é”™ï¼Œæç¤ºæ‰€æœ‰æå–æ–¹æ³•éƒ½å¤±è´¥äº†ã€‚
- **åŸå› **: `gmail-monitor.js` (Content Script) æ•è·åˆ°çš„é‚®ä»¶ DOM å…ƒç´ å†…å®¹æœ‰æ—¶ä¸ºç©ºå­—ç¬¦ä¸² `""`ï¼Œä½†è¿™ä¸ªç©ºå­—ç¬¦ä¸²ä¾ç„¶è¢«å‘é€åˆ°äº† Service Worker è¿›è¡Œå¤„ç†ï¼Œå¯¼è‡´åç»­æ‰€æœ‰å¤„ç†é€»è¾‘å¤±è´¥ã€‚
- **è§£å†³æ–¹æ¡ˆ**: åœ¨ Content Script å’Œ Service Worker ä¸­æ·»åŠ äº†**åŒé‡éç©ºéªŒè¯**ã€‚Content Script åœ¨å‘é€æ¶ˆæ¯å‰æ£€æŸ¥é‚®ä»¶å†…å®¹æ˜¯å¦ä¸ºç©ºï¼ŒService Worker åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åå†æ¬¡æ£€æŸ¥ï¼Œç¡®ä¿åªæœ‰åŒ…å«å®é™…å†…å®¹çš„é‚®ä»¶æ‰ä¼šè¢«é€å…¥æå–å¼•æ“ã€‚

### é—®é¢˜ 9: [å­˜å‚¨ API] è°ƒç”¨ `chrome.storage.local.get` æŠ›å‡º `TypeError`
- **èƒŒæ™¯**: è°ƒè¯• Popup UI å’Œè®¾ç½®æŒä¹…åŒ–æ—¶ã€‚
- **ç°è±¡**: åœ¨åŠ è½½ popup æˆ–ä¿å­˜è®¾ç½®æ—¶ï¼Œæ§åˆ¶å°æŠ¥å‘Š `TypeError`ã€‚
- **åŸå› **: è°ƒç”¨ `chrome.storage.local.get` æ–¹æ³•æ—¶ä¼ å…¥äº†é”™è¯¯çš„å‚æ•°æ ¼å¼ã€‚ä¾‹å¦‚ï¼Œé”™è¯¯åœ°ä¼ å…¥äº†å­—ç¬¦ä¸² `CONFIG.STORAGE_KEYS.LATEST_OTP`ï¼Œè€Œ API é¢„æœŸæ¥æ”¶çš„æ˜¯ä¸€ä¸ª**åŒ…å«é”®åçš„æ•°ç»„**æˆ–**ä¸€ä¸ªå®šä¹‰äº†é»˜è®¤å€¼çš„å¯¹è±¡**ã€‚
- **è§£å†³æ–¹æ¡ˆ**: ä¿®æ­£æ‰€æœ‰ `chrome.storage.local.get` çš„è°ƒç”¨ï¼Œç¡®ä¿å‚æ•°æ ¼å¼æ­£ç¡®ï¼Œä¾‹å¦‚ï¼š`chrome.storage.local.get([CONFIG.STORAGE_KEYS.LATEST_OTP])`ã€‚

### é—®é¢˜ 10: [UI] ç•Œé¢çŠ¶æ€ä¸æ›´æ–°
- **èƒŒæ™¯**: è°ƒè¯• Nano æ¨¡å‹ä¸‹è½½æµç¨‹æ—¶ã€‚
- **ç°è±¡**: ç‚¹å‡»ä¸‹è½½æŒ‰é’®åï¼ŒUI æ–‡æœ¬æ²¡æœ‰å˜åŒ–ï¼Œæˆ–è€…çŠ¶æ€æ›´æ–°ä¸æ­£ç¡®ï¼ˆä¾‹å¦‚ï¼Œä¸æ˜¾ç¤º "ä¸‹è½½ä¸­"ï¼‰ã€‚
- **åŸå› **: `popup.css` ä¸­ç¼ºå°‘å¯¹åº”çŠ¶æ€ï¼ˆå¦‚ `.downloading`, `.ready`, `.error`ï¼‰çš„æ ·å¼è§„åˆ™ã€‚JavaScript é€»è¾‘è™½ç„¶æ­£ç¡®åœ°æ·»åŠ äº† classï¼Œä½†å› ä¸ºæ²¡æœ‰å¯¹åº”çš„ CSSï¼Œæ‰€ä»¥è§†è§‰ä¸Šæ²¡æœ‰å˜åŒ–ã€‚
- **è§£å†³æ–¹æ¡ˆ**: ä¸º `ai-status-bar` å…ƒç´ æ·»åŠ äº†å®Œæ•´çš„ CSS æ ·å¼ï¼Œä»¥åŒ¹é…ä¸åŒçš„ AI çŠ¶æ€ï¼Œç¡®ä¿ UI èƒ½å¤Ÿå‡†ç¡®åæ˜ åå°çš„çœŸå®çŠ¶æ€ã€‚

### é—®é¢˜ 11: [æ ¸å¿ƒæŒ‘æˆ˜] Gemini Nano æ¨¡å‹ä¸‹è½½å¤±è´¥ (UI å¡é¡¿ã€æ— è¿›åº¦)
- **èƒŒæ™¯**: è¿™æ˜¯é¡¹ç›®ä¸­æœ€æ£˜æ‰‹ã€æŒç»­æ—¶é—´æœ€é•¿çš„é—®é¢˜ã€‚
- **ç°è±¡**: UIå¡åœ¨â€œä¸‹è½½ä¸­â€ä½†è¿›åº¦å§‹ç»ˆä¸º0%ï¼Œæˆ–è€…UIçŠ¶æ€åœ¨å…³é—­popupåæ— æ³•ä¿æŒï¼Œ`chrome://on-device-internals` æ˜¾ç¤ºæ¨¡å‹å®‰è£…æœªå®Œæˆã€‚
- **ç»¼åˆåŸå› **:
    1.  **ç”¨æˆ·æ‰‹åŠ¿ä¸¢å¤±**: `LanguageModel.create()` API **å¿…é¡»**åœ¨ä¸€ä¸ªç”±ç”¨æˆ·ç›´æ¥å‘èµ·çš„äº‹ä»¶ï¼ˆå¦‚ç‚¹å‡»ï¼‰ä¸­è°ƒç”¨æ‰èƒ½è§¦å‘ä¸‹è½½ã€‚æˆ‘ä»¬æœ€åˆé€šè¿‡ Service Worker æˆ– Offscreen é—´æ¥è§¦å‘çš„æ–¹å¼å¸¸å¸¸å¯¼è‡´æ‰‹åŠ¿ä¸Šä¸‹æ–‡ä¸¢å¤±ã€‚
    2.  **æ¶æ„è¿‡äºå¤æ‚**: ä¸‹è½½çŠ¶æ€çš„ç®¡ç†é€»è¾‘åˆ†æ•£åœ¨ `popup.js`, `service-worker.js`, å’Œ `offscreen.js` ä¸­ï¼Œå¯¼è‡´äº†çŠ¶æ€ä¸ä¸€è‡´ã€æ¶ˆæ¯å†²çªå’Œå¾ªç¯ä¾èµ–ã€‚
    3.  **Chrome ç”¨æˆ·é…ç½®æ–‡ä»¶æŸå**: åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå³æ—¶ä»£ç å®Œå…¨æ­£ç¡®ï¼Œä¸€ä¸ªâ€œè„â€çš„æˆ–æŸåçš„ Chrome ç”¨æˆ·é…ç½®æ–‡ä»¶ä¹Ÿä¼šé˜»æ­¢æ¨¡å‹ä¸‹è½½ã€‚
- **æœ€ç»ˆè§£å†³æ–¹æ¡ˆ**:
    1.  **æ¶æ„ç®€åŒ–**: ç§»é™¤äº†æ‰€æœ‰åœ¨ Service Worker å’Œ Offscreen ä¸­çš„ä¸‹è½½ç›¸å…³ä»£ç ã€‚**åªæœ‰ `popup.js`** è´Ÿè´£å¤„ç†æ¨¡å‹ä¸‹è½½ã€‚
    2.  **ä¿è¯ç”¨æˆ·æ‰‹åŠ¿**: å½“ç”¨æˆ·ç‚¹å‡» Popup ä¸­çš„ä¸‹è½½æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬**ç›´æ¥**åœ¨ `popup.js` çš„ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨ä¸­è°ƒç”¨ `LanguageModel.create()`ï¼Œç¡®ä¿äº†â€œç”¨æˆ·æ‰‹åŠ¿â€çš„æœ‰æ•ˆæ€§ã€‚
    3.  **æ›´æ¢é…ç½®æ–‡ä»¶**: å½“ä»£ç é€»è¾‘ç¡®è®¤æ— è¯¯ä½†ä¸‹è½½ä¾ç„¶å¤±è´¥æ—¶ï¼Œ**åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ Chrome ç”¨æˆ·é…ç½®æ–‡ä»¶** (`Create a new person/profile`) æ˜¯æœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆã€‚åœ¨æ–°ç¯å¢ƒä¸­ï¼Œæ¨¡å‹æˆåŠŸä¸‹è½½ã€‚

### é—®é¢˜ 12: [ä¸‹è½½å] `popup.js` ä¸­ `this` ä¸Šä¸‹æ–‡ä¸¢å¤±å¯¼è‡´ `TypeError`
- **èƒŒæ™¯**: åœ¨æ¨¡å‹ä¸‹è½½æˆåŠŸåï¼Œ`monitor` å›è°ƒè¢«è§¦å‘æ—¶ã€‚
- **ç°è±¡**: `popup.js` æ§åˆ¶å°æŠ›å‡º `TypeError: Cannot read properties of undefined`ï¼Œé€šå¸¸ä¸ `noProgressTimerId` ç­‰å®ä¾‹å±æ€§ç›¸å…³ã€‚
- **åŸå› **: åœ¨ `LanguageModel.create()` çš„ `monitor` å›è°ƒä¸­ä½¿ç”¨äº†æ™®é€šå‡½æ•° `function(m){...}`ï¼Œå¯¼è‡´ `this` çš„ä¸Šä¸‹æ–‡æ”¹å˜ï¼Œä¸å†æŒ‡å‘ `PopupController` çš„å®ä¾‹ã€‚
- **è§£å†³æ–¹æ¡ˆ**: å°†å›è°ƒå‡½æ•°æ”¹ä¸º**ç®­å¤´å‡½æ•°** `monitor: (m) => { ... }`ï¼Œç®­å¤´å‡½æ•°ä¸ä¼šåˆ›å»ºè‡ªå·±çš„ `this` ä¸Šä¸‹æ–‡ï¼Œå› æ­¤å¯ä»¥æ­£ç¡®åœ°ä»çˆ¶ä½œç”¨åŸŸæ•è·å¹¶ä½¿ç”¨ `PopupController` çš„å®ä¾‹ã€‚

### é—®é¢˜ 13: [æ¶ˆæ¯é€šé“] `A listener indicated an asynchronous response...`
- **èƒŒæ™¯**: åœ¨å®é™…æµ‹è¯•ä¸‰å±‚å¼•æ“æ—¶ï¼Œå‘ç°å¤§é‡çš„æ¶ˆæ¯é€šé“é”™è¯¯ã€‚
- **ç°è±¡**: æ§åˆ¶å°é¢‘ç¹æŠ¥é”™ `Error: A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received`ã€‚
- **åŸå› **: **å…³é”®çš„æ¶æ„ç¼ºé™·**ã€‚`offscreen.js` å’Œ `service-worker.js` çš„æ¶ˆæ¯ç›‘å¬å™¨éƒ½è¿”å›äº† `true`ï¼ˆè¡¨ç¤ºä¼šå¼‚æ­¥å“åº”ï¼‰ï¼Œä½†åœ¨æ£€æŸ¥ `target` å±æ€§å‘ç°æ¶ˆæ¯ä¸å±äºè‡ªå·±åï¼Œç›´æ¥ `return` è€Œæ²¡æœ‰è°ƒç”¨ `sendResponse()`ï¼Œå¯¼è‡´æ¶ˆæ¯é€šé“æ°¸ä¹…æŒ‚èµ·ã€‚
- **è§£å†³æ–¹æ¡ˆ**: 
  - **ç«‹å³è¿”å› `false`**ï¼šå½“æ£€æµ‹åˆ°æ¶ˆæ¯çš„ `target` ä¸åŒ¹é…æ—¶ï¼Œç«‹å³ `return false`ï¼Œå‘Šè¯‰ Chrome è¿™ä¸ªç›‘å¬å™¨ä¸ä¼šå¤„ç†æ­¤æ¶ˆæ¯ã€‚
  - **åªåœ¨çœŸæ­£å¤„ç†æ—¶è¿”å› `true`**ï¼šåªæœ‰å½“ç¡®è®¤è¦å¤„ç†æ¶ˆæ¯æ—¶ï¼Œæ‰ `return true` å¹¶è°ƒç”¨å¼‚æ­¥å¤„ç†å‡½æ•°ã€‚
  ```javascript
  // ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
  chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    handleMessage(request, sendResponse);
    return true; // æ€»æ˜¯è¿”å› trueï¼Œå³ä½¿ä¸å¤„ç†
  });
  
  // ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
  chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.target !== 'offscreen') {
      return false; // ä¸å¤„ç†ï¼Œç«‹å³è¿”å› false
    }
    handleMessage(request, sendResponse);
    return true; // åªæœ‰åœ¨å¤„ç†æ—¶æ‰è¿”å› true
  });
  ```

### é—®é¢˜ 14: [æ­£åˆ™å¼•æ“] ç®€å• OTP æ— æ³•è¯†åˆ« - "Your verification code is: 123456"
- **èƒŒæ™¯**: åœ¨ç«¯åˆ°ç«¯æµ‹è¯•ä¸­ï¼Œå‘é€ç®€å•çš„è‹±æ–‡ OTP é‚®ä»¶ç«Ÿç„¶æ— æ³•è¯†åˆ«ã€‚
- **ç°è±¡**: 
  - æµ‹è¯•æ–‡æœ¬ "Your verification code is: 123456" ç½®ä¿¡åº¦ä¸º 0
  - æ­£åˆ™å¼•æ“å®Œå…¨æ— æ³•æå–æ­¤ OTP
- **ç»¼åˆåŸå› **:
  1. **è¿‡åº¦æ¸…ç†**ï¼š`cleanContent()` å‡½æ•°ä½¿ç”¨ `/[^\w\s\dï¼š:]/g` ç§»é™¤äº†æ‰€æœ‰æ ‡ç‚¹ç¬¦å·ï¼ŒåŒ…æ‹¬è‹±æ–‡å†’å· `:`ï¼Œå¯¼è‡´ "code: 123456" å˜æˆäº† "code 123456"ï¼Œè€Œæ­£åˆ™è¡¨è¾¾å¼éœ€è¦å†’å·æ‰èƒ½åŒ¹é…ã€‚
  2. **æ­£åˆ™è¿‡äºä¸¥æ ¼**ï¼šè‹±æ–‡è§„åˆ™çš„æ­£åˆ™è¡¨è¾¾å¼å¦‚ `/verification code is[ï¼š:]\s*(\d{4,8})/i` æ— æ³•åŒ¹é… "Your verification code is:"ï¼Œå› ä¸ºå‰é¢å¤šäº† "Your"ã€‚
- **è§£å†³æ–¹æ¡ˆ**: 
  1. **ç®€åŒ–å†…å®¹æ¸…ç†**ï¼šåªä¿ç•™å¿…è¦çš„ç©ºæ ¼è§„èŒƒåŒ–ï¼Œä¸å†ç§»é™¤æ ‡ç‚¹ç¬¦å·ã€‚
  2. **å¢å¼ºæ­£åˆ™çµæ´»æ€§**ï¼š
     - ä½¿ç”¨ `\s*[ï¼š:is\s]+` ä»£æ›¿ä¸¥æ ¼çš„ `[ï¼š:]`ï¼Œå¯ä»¥åŒ¹é… "code:", "code is", "code  " ç­‰å„ç§å˜ä½“
     - æ·»åŠ  `your\s+(?:verification\s+)?code` æ¥åŒ¹é… "Your code" å’Œ "Your verification code"
     - å¢åŠ  `security code` ç­‰å¸¸è§æ¨¡å¼
  ```javascript
  // ä¿®å¤å‰
  /verification code is[ï¼š:]\s*(\d{4,8})/i  // æ— æ³•åŒ¹é… "Your verification code is: 123456"
  
  // ä¿®å¤å
  /your\s+(?:verification\s+)?code\s*[ï¼š:is\s]+(\d{4,8})/i  // âœ… å¯ä»¥åŒ¹é…
  ```

### é—®é¢˜ 15: [Content Script] `Extension context invalidated` åœ¨å­˜å‚¨å»é‡åˆ—è¡¨æ—¶å‡ºç°
- **èƒŒæ™¯**: å°†æå–è¿‡çš„é‚®ä»¶ ID æŒä¹…åŒ–åˆ° `chrome.storage.local` ä»¥é¿å…é‡å¤å¤„ç†ã€‚
- **ç°è±¡**: Gmail é¡µé¢è¢«åˆ·æ–°æˆ–æ‰©å±•é‡æ–°åŠ è½½åï¼Œæ§åˆ¶å°åå¤å‡ºç° `Extension context invalidated`ï¼ŒåŒæ—¶æå–æµç¨‹è¢«æ‰“æ–­ã€‚
- **åŸå› **: å·²å¸è½½çš„æ—§ç‰ˆæœ¬ content script è¿˜åœ¨å°è¯•å†™å…¥ storageï¼›API è¢«è°ƒç”¨æ—¶æ‰©å±•ä¸Šä¸‹æ–‡å·²ç»å¤±æ•ˆã€‚
- **è§£å†³æ–¹æ¡ˆ**: åœ¨ `persistProcessedKeys()` ä¸­å…ˆæ ¡éªŒ `chrome.runtime.id` æ˜¯å¦å­˜åœ¨ï¼›è°ƒç”¨ `chrome.storage.local.set` æ—¶ä½¿ç”¨å›è°ƒæ£€æŸ¥ `chrome.runtime.lastError`ï¼Œå¯¹ `Extension context invalidated` ä»…è®°å½•ä¸€æ¬¡è­¦å‘Šå¹¶è·³è¿‡å†™å…¥ï¼Œä»è€Œæ—¢ä¿ç•™å»é‡æœºåˆ¶åˆé¿å…æ‰“æ–­æµç¨‹ã€‚

### é—®é¢˜ 16: [Offscreen Document] `Only a single offscreen document may be created`
- **èƒŒæ™¯**: Service Worker åœ¨è°ƒç”¨ Gemini Nano ä¹‹å‰ä¼šé€šè¿‡ `callOffscreenNano()` åˆ›å»º offscreen documentã€‚
- **ç°è±¡**: åœ¨ Gmail é¡µé¢å°šæœªå‘é€éªŒè¯ç å‰å¤šæ¬¡æ‰“å¼€ Popupï¼Œæ§åˆ¶å°å¶å‘è¯¥é”™è¯¯ä½†æµç¨‹è¢«ä¸­æ–­ã€‚
- **åŸå› **: åœ¨ `chrome.offscreen.hasDocument()` ä¸ `createDocument()` ä¹‹é—´å­˜åœ¨ç«æ€ï¼Œå¯¼è‡´åŒä¸€æ—¶é—´å°è¯•åˆ›å»ºå¤šä¸ª offscreen documentã€‚
- **è§£å†³æ–¹æ¡ˆ**: ä¸º `chrome.offscreen.createDocument()` æ·»åŠ  try/catchï¼›é‡åˆ°è¯¥é”™è¯¯æ—¶åªè®°å½• warning å¹¶ç»§ç»­æ‰§è¡Œï¼Œå…¶å®ƒçœŸæ­£çš„å¼‚å¸¸ä¾æ—§æŠ›å‡ºã€‚è¿™æ ·å¯ä¿è¯ Nano åªå®ä¾‹åŒ–ä¸€æ¬¡ï¼ŒåŒæ—¶ä¸å½±å“æå–è·¯å¾„ã€‚

---

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

- **æŸ¥çœ‹ Offscreen Console**: åœ¨ `chrome://extensions` é¡µé¢ï¼Œæ‰¾åˆ°ä½ çš„æ‰©å±•ï¼Œç‚¹å‡» `Service Worker` é“¾æ¥ï¼Œåœ¨æ‰“å¼€çš„æ§åˆ¶å°ä¸­æ‰§è¡Œ `chrome.offscreen.openDocument('src/offscreen/offscreen.html')`ï¼Œå³å¯åœ¨å¼¹å‡ºçš„çª—å£ä¸­æŸ¥çœ‹ Offscreen çš„æ—¥å¿—ã€‚
- **æ£€æŸ¥æ¨¡å‹çŠ¶æ€**: è®¿é—® `chrome://on-device-internals` æŸ¥çœ‹ Gemini Nano æ¨¡å‹çš„ä¸‹è½½çŠ¶æ€ã€ç¡¬ä»¶è¦æ±‚å’Œå¯ç”¨æ€§ã€‚
- **ä½¿ç”¨å¹²å‡€çš„é…ç½®æ–‡ä»¶**: å¦‚æœæ€€ç–‘æ˜¯ç¯å¢ƒé—®é¢˜ï¼ŒåŠ¡å¿…åœ¨æ–°çš„ Chrome ç”¨æˆ·é…ç½®æ–‡ä»¶ä¸­æµ‹è¯•ã€‚

