# Gmail OTP AutoFill - 战略计划与路线图

本文档旨在对项目当前状态进行一次全面的复盘与反思，并基于此制定一个清晰、分阶段的战略计划，以指导后续的开发工作，最终实现产品的终极目标。

---

## 1. 终极目标：零接触、主动式 OTP 体验 (Zero-Touch, Proactive Experience)

我们产品的核心价值在于**为用户节省时间和精力**。基于此，我们定义产品的终极理想状态为：

1.  **主动感知 (Proactive Awareness)**: 当用户在任何网站上请求验证码时，插件能“感知”到这个意图，并自动进入戒备状态。
2.  **静默监控 (Silent Monitoring)**: 在后台静默检查 Gmail，无论用户是否打开或关注 Gmail 标签页。
3.  **精准提取 (Precision Extraction)**: 新邮件到达后，能从复杂的邮件内容（如订单确认邮件）中精准地识别并提取出真正的 OTP，忽略所有干扰项（如订单号、航班号）。
4.  **主动推送 (Proactive Delivery)**: 通过系统通知或自动填充等方式，主动将获取到的 OTP 推送给用户，整个过程无需用户切换标签页或手动复制粘贴。

## 2. 当前状态与核心局限

经过前一阶段的开发，我们已成功搭建了三层提取引擎和基本的用户界面。然而，当前架构也暴露了两个核心局限，阻碍了我们达成终极目标：

-   **局限 A：被动式触发 (Passive Triggering)**
    -   **现象**: 插件只有在用户已经打开 Gmail 标签页，并且通过点击或滚动触发了 Content Script 的 DOM 扫描后，才能开始工作。这导致了延迟，并且要求用户必须与 Gmail 页面进行فاعل。
    -   **根源**: 当前架构强依赖于一个在**活动页面**上运行的 Content Script。

-   **局限 B：提取精度不足 (Insufficient Extraction Accuracy)**
    -   **现象**: 面对包含多个数字的复杂邮件（如 Trip.com 的订单确认），提取引擎会混淆订单号和验证码，导致提取错误。
    -   **根源**: 我们给予正则和 AI 引擎的上下文信息过少，规则和指令不够明确。

## 3. 核心问题的深度思考 (Brainstorming & Insights)

### 3.1. 正则表达式是一个“无限漩涡”吗？
**是的**。正则表达式本质上是有限的规则集，非常适合处理标准化文本。但 OTP 邮件的格式千奇百怪，试图用正则覆盖所有情况是不现实的，只会创造一个脆弱且难以维护的系统。

**策略转变**: 我们必须明确**正则表达式的定位**：它是一个**“快速通道”**，旨在以最高效率处理掉 **80% 的标准化邮件**。对于剩下的 20% 复杂情况，我们必须依赖更智能的工具。

### 3.2. 如何充分利用大模型 (Gemini Nano) 的能力？
大模型的核心优势在于**理解上下文和语义**。我们必须将其视为一个可编程的推理引擎，而非简单的模式匹配器。

**核心策略**:
1.  **情境丰富的 Prompt**: 不仅要告诉模型“找什么”，更要用“负向指令”告诉它“**不要什么**”（例如，“忽略订单号、预订号”）。
2.  **利用模型的推理能力**: 要求模型返回提取的“理由”（`reasoning`），并在 Service Worker 中进行二次验证。如果模型是基于“Booking No.”提取的数字，我们可以基于这个推理否决该结果。

### 3.3. 如何在不引入 Gmail API 的前提下提升“及时性”？
我们发现了一个关键的可行性路径：**Chrome 的 Content Script 在非活动标签页中依然可以工作**！

**策略洞察**: 只要用户保持一个 Gmail 标签页（即使是在后台，未被选中），我们的 `MutationObserver` 就能在后台检测到新邮件的 DOM 更新，并触发提取流程。这让我们可以在不立即进行复杂架构升级（引入 Gmail API）的前提下，实现“**无需切换标签页**”的核心体验。

---

## 4. 分阶段行动计划 (Phased Action Plan)

基于以上分析，我们制定了以下三阶段计划：

### **阶段一：实现“半后台”精准提取 (Immediate Priority)**

**目标**: 立即解决提取精度问题，并实现“无需切换到 Gmail 标签页”的核心体验。这是当前风险最低、回报最高的阶段。

-   ✅ **行动 1.1：优化 AI Prompt (提升精度)**
    -   **任务**: 在 `constants.js` 的 `buildOTPPrompt` 函数中，加入明确的“负向指令”（如“忽略订单号、预订号”），指导 AI 更精准地决策。

-   ✅ **行动 1.2：实现启发式后处理 (提升精度)**
    -   **任务**: 在 `service-worker.js` 中，当收到 AI 的提取结果后，增加一个检查步骤。分析返回的 `reasoning` 字段，如果包含负面关键词，则判定为提取失败，转而尝试下一层引擎。

-   ✅ **行动 1.3：验证并巩固“半后台”监控 (提升体验)**
    -   **任务**: 通过测试验证 `gmail-monitor.js` 的 `MutationObserver` 在非活动标签页中能够稳定工作。并根据测试结果，微调 DOM 扫描逻辑和选择器，以适应后台标签页的渲染模式。

-   ✅ **行动 1.4：只对“真正的新验证码邮件”触发 (提升稳定性)**
    -   **任务**: 更新 Gmail DOM 监听逻辑，专注于 `.zE` 未读线程或带有 `data-legacy-message-id` 的新邮件；维护一份持久化的「已处理邮件 ID」列表；在触发前检查邮件主题与正文是否含验证码相关关键词，从根源上避免旧邮件或非验证码邮件的误触发。
    -   **预期效果**: 打开历史邮件或浏览旧内容不会触发任何提取流程；只要邮箱收到新的验证码邮件（即使 Gmail 标签页在后台），才会触发三层引擎并更新 Popup。

### **阶段二：实现主动感知 (Future Enhancement)**

**目标**: 让插件能“猜到”用户需要 OTP，并主动进入戒备状态，为最终的 Gmail API 架构做准备。

-   🟡 **行动 2.1：创建全局 OTP 输入框监听器**
    -   **任务**: 创建一个新的、轻量的 Content Script，注入到所有网站 (`<all_urls>`)，当用户聚焦于 OTP 输入框时，向 Service Worker 发送“高度戒备”信号。

-   🟡 **行动 2.2：实现动态轮询频率 (与阶段三联动)**
    -   **任务**: （仅在引入 Gmail API 后）当 Service Worker 收到“高度戒备”信号后，将后台轮询的频率从 30 秒动态调整为 5 秒，以实现更快的响应。

### **阶段三：架构升级 - 引入完全后台监控 (Architectural Upgrade)**

**目标**: 彻底摆脱对 Gmail 标签页的依赖，实现终极的“零接触”体验。

-   🔵 **行动 3.1：重新集成 Gmail API**
    -   **任务**: 在 Service Worker 中实现基于 OAuth 2.0 (refresh token) 的 Gmail API 认证，用于在后台静默访问。

-   🔵 **行动 3.2：实现基于 `chrome.alarms` 的后台轮询**
    -   **任务**: 使用 `chrome.alarms` API 创建一个高效的后台定时任务，定期唤醒 Service Worker 检查新邮件。

-   🔵 **行动 3.3：实现系统级通知**
    -   **任务**: 当在后台成功提取到 OTP 后，使用 `chrome.notifications` API 创建一个原生的系统通知，主动将验证码推送给用户。

---
**当前结论**: 我们的首要任务是立即开始执行**阶段一**。它将以最小的改动，带来最大的体验提升和稳定性增强。
